# CodeArena - Render.com Deployment Guide

## Prerequisites

1. **GitHub Repository**: Push your CodeArena project to GitHub
2. **Render Account**: Sign up at [render.com](https://render.com)
3. **MongoDB Atlas**: Ensure your MongoDB Atlas cluster is set up and accessible from anywhere (0.0.0.0/0)

## Deployment Options

### Option 1: Automated Deployment (Recommended)

Using the included `render.yaml` file for Infrastructure as Code:

1. **Connect Repository**:
   - Go to [Render Dashboard](https://dashboard.render.com/)
   - Click **"New"** → **"Blueprint"**
   - Connect your GitHub repository
   - Render will detect `render.yaml` automatically

2. **Configure Environment Variables**:
   
   **Backend Service (codearena-backend)**:
   - `MONGODB_URI`: Your MongoDB Atlas connection string
   - `JWT_SECRET`: Will be auto-generated by Render
   - `FRONTEND_URL`: Will be auto-linked to frontend service
   
   **Optional - OAuth Configuration**:
   - `GOOGLE_CLIENT_ID`: From Google Cloud Console
   - `GOOGLE_CLIENT_SECRET`: From Google Cloud Console
   - `GOOGLE_CALLBACK_URL`: `https://your-backend.onrender.com/api/auth/google/callback`
   - `FACEBOOK_APP_ID`: From Facebook Developers
   - `FACEBOOK_APP_SECRET`: From Facebook Developers
   - `FACEBOOK_CALLBACK_URL`: `https://your-backend.onrender.com/api/auth/facebook/callback`

   **Frontend Service (codearena-frontend)**:
   - `VITE_API_URL`: Will be auto-linked to backend service URL + `/api`

3. **Deploy**:
   - Click **"Apply"**
   - Render will deploy both services automatically
   - Wait for both builds to complete (~5-10 minutes)

4. **Post-Deployment**:
   - Get your frontend URL: `https://codearena-frontend.onrender.com`
   - Get your backend URL: `https://codearena-backend.onrender.com`
   - Update OAuth callback URLs in Google/Facebook consoles if using OAuth

---

### Option 2: Manual Deployment

#### Step 1: Deploy Backend

1. **Create Web Service**:
   - Go to Render Dashboard
   - Click **"New"** → **"Web Service"**
   - Connect your GitHub repository
   - Configure:
     - **Name**: `codearena-backend`
     - **Root Directory**: `backend`
     - **Runtime**: `Node`
     - **Build Command**: `npm install`
     - **Start Command**: `npm start`
     - **Plan**: `Free`

2. **Environment Variables**:
   ```
   NODE_ENV=production
   PORT=5000
   MONGODB_URI=your-mongodb-connection-string
   JWT_SECRET=your-secure-random-string
   JWT_EXPIRE=7d
   FRONTEND_URL=https://your-frontend-url.onrender.com
   ```

3. **Optional OAuth Variables**:
   ```
   GOOGLE_CLIENT_ID=your-google-client-id
   GOOGLE_CLIENT_SECRET=your-google-secret
   GOOGLE_CALLBACK_URL=https://your-backend.onrender.com/api/auth/google/callback
   FACEBOOK_APP_ID=your-facebook-app-id
   FACEBOOK_APP_SECRET=your-facebook-secret
   FACEBOOK_CALLBACK_URL=https://your-backend.onrender.com/api/auth/facebook/callback
   ```

4. **Health Check**:
   - Path: `/api/health`

5. Deploy and wait for the build to complete

#### Step 2: Deploy Frontend

1. **Create Static Site**:
   - Click **"New"** → **"Static Site"**
   - Connect the same GitHub repository
   - Configure:
     - **Name**: `codearena-frontend`
     - **Root Directory**: `frontend`
     - **Build Command**: `npm install && npm run build`
     - **Publish Directory**: `dist`
     - **Plan**: `Free`

2. **Environment Variables**:
   ```
   VITE_API_URL=https://your-backend.onrender.com/api
   ```
   Replace `your-backend` with your actual backend service URL from Step 1

3. **Rewrites for React Router**:
   - Add rewrite rule:
     - **Source**: `/*`
     - **Destination**: `/index.html`
     - **Action**: `Rewrite`

4. Deploy and wait for the build to complete

#### Step 3: Update Backend FRONTEND_URL

1. Go back to your backend service settings
2. Update `FRONTEND_URL` environment variable with your actual frontend URL
3. Save - this will trigger a redeploy

---

## OAuth Configuration (Optional)

If you want to enable Google/Facebook login:

### Google OAuth

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing
3. Enable **Google+ API**
4. Go to **Credentials** → **Create Credentials** → **OAuth 2.0 Client ID**
5. Configure consent screen
6. Add Authorized redirect URIs:
   - `http://localhost:5000/api/auth/google/callback` (development)
   - `https://your-backend.onrender.com/api/auth/google/callback` (production)
7. Copy Client ID and Client Secret to Render environment variables

### Facebook OAuth

1. Go to [Facebook Developers](https://developers.facebook.com/)
2. Create a new app
3. Add **Facebook Login** product
4. Configure Valid OAuth Redirect URIs:
   - `http://localhost:5000/api/auth/facebook/callback` (development)
   - `https://your-backend.onrender.com/api/auth/facebook/callback` (production)
5. Copy App ID and App Secret to Render environment variables

---

## MongoDB Atlas Configuration

Ensure your MongoDB Atlas cluster allows connections from Render:

1. Go to MongoDB Atlas → **Network Access**
2. Click **"Add IP Address"**
3. Add `0.0.0.0/0` (allow from anywhere) or Render's IP addresses
4. Save

---

## Verifying Deployment

1. **Backend Health Check**:
   ```
   https://your-backend.onrender.com/api/health
   ```
   Should return: `{"status":"ok","message":"CodeArena API is running"}`

2. **Frontend**:
   - Visit: `https://your-frontend.onrender.com`
   - Should see the CodeArena landing page
   - Try logging in/registering

3. **Database Connection**:
   - Check backend logs in Render dashboard
   - Should see: "MongoDB Connected: ..."

---

## Important Notes

### Free Tier Limitations

- **Backend**: Spins down after 15 minutes of inactivity
  - First request after spin-down takes ~30-60 seconds
  - Consider upgrading to paid plan for always-on service

- **Frontend**: Static hosting, no spin-down issues

### Socket.IO Considerations

- WebSocket connections work on Render Free tier
- May experience disconnections during backend spin-down
- Frontend will auto-reconnect when backend wakes up

### Build Times

- **Backend**: ~2-3 minutes
- **Frontend**: ~3-5 minutes (includes Vite build)

---

## Troubleshooting

### CORS Errors

- Ensure `FRONTEND_URL` in backend matches your actual frontend URL
- Check browser console for exact CORS error
- Verify allowedOrigins in `backend/server.js`

### OAuth Not Working

- Verify callback URLs match exactly in Google/Facebook consoles
- Check environment variables are set correctly
- Ensure backend URL uses HTTPS (not HTTP)

### Database Connection Issues

- Verify MongoDB Atlas network access allows Render IPs
- Check connection string format
- Look for connection errors in backend logs

### Build Failures

- Check build logs in Render dashboard
- Ensure all dependencies are in `package.json` (not devDependencies)
- Verify Node version compatibility

---

## Cost Optimization

**Free Tier Setup** (Current):
- Backend: Free Web Service ($0/month)
- Frontend: Free Static Site ($0/month)
- MongoDB Atlas: Free M0 Cluster ($0/month)
- **Total**: $0/month

**Production Ready**:
- Backend: Starter Web Service ($7/month) - No spin-down, better performance
- Frontend: Free Static Site ($0/month)
- MongoDB Atlas: M2 Cluster (~$9/month) - Better performance
- **Total**: ~$16/month

---

## Post-Deployment Checklist

- [ ] Backend health check returns OK
- [ ] Frontend loads successfully
- [ ] User registration works
- [ ] User login works
- [ ] Dashboard loads after login
- [ ] Practice problems display
- [ ] Code execution works (Piston API)
- [ ] OAuth login works (if configured)
- [ ] Real-time features work (lobbies, competitions)
- [ ] MongoDB data persists correctly

---

## Support

For Render-specific issues:
- [Render Documentation](https://render.com/docs)
- [Render Community](https://community.render.com/)

For CodeArena issues:
- Check application logs in Render dashboard
- Review error messages in browser console
- Verify environment variables are set correctly
